#@TYPE: Machine
#@NAME: zynqmp-zcu104-sdt-full
#@DESCRIPTION: Machine configuration for the zynqmp-zcu104-sdt-full boards.

BBMULTICONFIG += " \
    zynqmp-zcu104-sdt-full-cortexa53-fsbl \
    zynqmp-zcu104-sdt-full-cortexr5-0-baremetal \
    zynqmp-zcu104-sdt-full-microblaze-pmu \
    "

#### Preamble
MACHINEOVERRIDES =. "${@['', 'zynqmp-zcu104-sdt-full:']['zynqmp-zcu104-sdt-full' !='${MACHINE}']}"
#### Regular settings follow
TUNEFILE[microblaze-pmu] = "conf/machine/include/zynqmp-zcu104-sdt-full/microblaze.inc"

# This machine is for SDT builds only.
XILINX_WITH_ESW = "sdt"

# Enable this to add sdt-artifacts dependency in fsbl-firmware recipe.
USE_SDT_ARTIFACTS = "1"

# First Stage Boot Loader
FSBL_DEPENDS = ""
FSBL_MCDEPENDS = "mc::zynqmp-zcu104-sdt-full-cortexa53-fsbl:fsbl-firmware:do_deploy"
FSBL_DEPLOY_DIR = "${TMPDIR}-zynqmp-zcu104-sdt-full-cortexa53-fsbl/deploy/images/${MACHINE}"

# Cortex-R5 First Stage Boot Loader
R5FSBL_DEPENDS = ""
R5FSBL_MCDEPENDS = "mc::zynqmp-zcu104-sdt-full-cortexr5-fsbl:fsbl-firmware:do_deploy"
R5FSBL_DEPLOY_DIR = "${TMPDIR}-zynqmp-zcu104-sdt-full-cortexr5-fsbl/deploy/images/${MACHINE}"

# PMU Firware
PMU_DEPENDS = ""
PMU_MCDEPENDS = "mc::zynqmp-zcu104-sdt-full-microblaze-pmu:pmu-firmware:do_deploy"
PMU_FIRMWARE_DEPLOY_DIR = "${TMPDIR}-zynqmp-zcu104-sdt-full-microblaze-pmu/deploy/images/${MACHINE}"

# Set the default (linux) domain device tree
SYSTEM_DTFILE_DEPENDS = "sdt-artifacts"
CONFIG_DTFILE_DIR = "${BSPLAYERDIR_amd-adaptive-socs-bsp}/conf/dts/zynqmp-zcu104-sdt-full"
CONFIG_DTFILE ?= "${CONFIG_DTFILE_DIR}/cortexa53-linux.dts"
CONFIG_DTFILE[vardepsexclude] += "CONFIG_DTFILE_DIR"

# System Device Tree does not use HDF_MACHINE
HDF_MACHINE = ""

# Set the system device trees
SYSTEM_DTFILE_DEPENDS = "sdt-artifacts"
SYSTEM_DTFILE_DIR = "${RECIPE_SYSROOT}${datadir}/sdt/${MACHINE}/zcu104-zynqmp-2024.2_0807_1-zcu104-sdtws-2024.2"
SYSTEM_DTFILE = "${SYSTEM_DTFILE_DIR}/system-top.dts"
SYSTEM_DTFILE[vardepsexclude] += "SYSTEM_DTFILE_DIR"

# Load the dynamic machine features
include conf/machine/include/zynqmp-zcu104-sdt-full/${BB_CURRENT_MC}-features.conf
LIBXIL_CONFIG = "conf/machine/include/zynqmp-zcu104-sdt-full/${BB_CURRENT_MC}-libxil.conf"

# Update bootbin to use proper device tree
BIF_PARTITION_IMAGE[device-tree] = "${RECIPE_SYSROOT}/boot/devicetree/${@os.path.basename(d.getVar('CONFIG_DTFILE').replace('.dts', '.dtb'))}"

# Remap boot files to ensure the right device tree is listed first
IMAGE_BOOT_FILES =+ "devicetree/${@os.path.basename(d.getVar('CONFIG_DTFILE').replace('.dts', '.dtb'))}"

# Yocto arm-trusted-firmware(TF-A) variables
ATF_CONSOLE ?= "cadence"
TFA_BL33_LOAD ?= "0x8000000"

# Set DDR Base address for u-boot-xlnx-scr variables
DDR_BASEADDR ?= "0x0"
SKIP_APPEND_BASEADDR ?= "0"

# Yocto KERNEL Variables
UBOOT_ENTRYPOINT  ?= "0x200000"
UBOOT_LOADADDRESS ?= "0x200000"

# Yocto MACHINE_FEATURES Variable
MACHINE_FEATURES += "fpga-overlay vcu mali400"

# Required generic machine inclusion
require conf/machine/zynqmp-generic.conf

#### No additional settings should be after the Postamble
#### Postamble
PACKAGE_EXTRA_ARCHS:append = "${@['', ' zynqmp_zcu104_sdt_full']['zynqmp-zcu104-sdt-full' != '${MACHINE}']}"
